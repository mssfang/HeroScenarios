package textAnalytics;

import java.io.*;
import java.net.*;
import java.util.*;
import javax.net.ssl.HttpsURLConnection;

/*
 * Gson: https://github.com/google/gson
 * Maven info:
 *     groupId: com.google.code.gson
 *     artifactId: gson
 *     version: 2.8.1
 *
 * Once you have compiled or downloaded gson-2.8.1.jar, assuming you have placed it in the
 * same folder as this file (DetectLanguage.java), you can compile and run this program at
 * the command line as follows.
 *
 * javac DetectLanguage.java -classpath .;gson-2.8.1.jar -encoding UTF-8
 * java -cp .;gson-2.8.1.jar DetectLanguage
 */
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;

public class DetectLanguage {

	private static String accessKey;
	private static String host;
	private static String path;
	public DetectLanguage(String accessKey, String host, String path) {
		this.accessKey = accessKey;
		this.host = host;
		this.path = path;
	}
	
    public static String GetLanguage (Documents documents) throws Exception {
        String text = new Gson().toJson(documents);
        byte[] encoded_text = text.getBytes("UTF-8");

        URL url = new URL(host+path);
        HttpsURLConnection connection = (HttpsURLConnection) url.openConnection();
        connection.setRequestMethod("POST");
        connection.setRequestProperty("Content-Type", "text/json");
        connection.setRequestProperty("Ocp-Apim-Subscription-Key", accessKey);
        connection.setDoOutput(true);

        DataOutputStream wr = new DataOutputStream(connection.getOutputStream());
        wr.write(encoded_text, 0, encoded_text.length);
        wr.flush();
        wr.close();

        StringBuilder response = new StringBuilder ();
        BufferedReader in = new BufferedReader(new InputStreamReader(connection.getInputStream()));
        String line;
        while ((line = in.readLine()) != null) {
            response.append(line);
        }
        in.close();

        return response.toString();
    }

    public static ArrayList<String> parseLanguage(String response) {
    	JsonParser parser = new JsonParser();
        JsonObject json = parser.parse(response).getAsJsonObject();
    	JsonArray documents = json.getAsJsonArray("documents");
		ArrayList<String>  detactLanguageList = new ArrayList<>();

    	for (int i = 0; i < documents.size(); i++) {
    		JsonObject doc = documents.get(i).getAsJsonObject();
    		String id = doc.get("id").getAsString();

    		JsonArray detectLanguages = doc.getAsJsonArray("detectedLanguages");
    		
    		for (int j = 0; j < detectLanguages.size(); j++) {
    			JsonObject languageObj = detectLanguages.get(j).getAsJsonObject();
    			detactLanguageList.add(languageObj.get("iso6391Name").getAsString());
    		}
    		
    	}
    	return detactLanguageList;
    }
    
    public static String prettify(String json_text) {
        JsonParser parser = new JsonParser();
        JsonObject json = parser.parse(json_text).getAsJsonObject();
        Gson gson = new GsonBuilder().setPrettyPrinting().create();
        return gson.toJson(json);
    } 
    
//    public static void main (String[] args) {
//        try {
//            Documents documents = new Documents ();
//            documents.add ("1", "This is a document written in English.");
//            documents.add ("2", "Este es un document escrito en Español.");
//            documents.add ("3", "这是一个用中文写的文件");
//
//            String response = GetLanguage (documents);
//            System.out.println (prettify (response));
//        }
//        catch (Exception e) {
//            System.out.println (e);
//        }
//    }
}